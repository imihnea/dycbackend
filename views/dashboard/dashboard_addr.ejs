<% include ../partials/header %>
<link rel="stylesheet" type="text/css" media="screen" href="/dist/css/dashboard.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/dist/css/bulma-steps.min.css" />
<script type="text/javascript" src="/dist/js/bulma-steps.min.js"></script>
<div class="columns">
    <% include ../partials/sidebar %>
    <div class="column dashboard-right">
        <div class="dashTop column">
            <h2 class="title">Addresses</h2>
        </div>
        <br>
        <div class="container is-fluid" style="margin-bottom: 3vh;">
            <% if(errors){ %>
                <div class="notification is-danger" role="alert"> 
                <% errors.forEach(function( err){ %>
                    <%= err.msg %><br>
                <% }) %>
                </div>
            <% } %>
        </div>
        <div class="columns">
            <div class="column is-four-fifths" style="margin: auto;">
                <div class="columns">
                    <div class="column frame">  
                        <div class="adr">
                            <div class="currency"> 
                                <img src="../../dist/img/bitcoin.png" class="adr_img" alt="Bitcoin">
                                <p class="title"> = $<%= btcrate %> USD</p>
                            </div>
                            <div class="columns">
                                <div class="column">
                                    <div class="address">
                                        <label class="label adrlabel">Current<br/>  Withdrawal Address</label>
                                        <input class="input smmargin adradr" name="user[btcadr]" value="<%= user.btcadr %>" readonly />
                                    </div>
                                    <form action="/dashboard/addresses" method="POST">
                                        <div class="address">
                                            <label class="label adrlabel">New <br/> Withdrawal Address</label>
                                            <input class="input smmargin adradr" name="btcadr" placeholder="Bitcoin Address" type="text" required />
                                        </div>
                                        <button class="button is-primary">Change Address</button>
                                    </form>    
                                    <div class="address">
                                        <label class="label adrlabel" style="margin-top: 1.2em;">Balance</label>
                                        <input class="input smmargin adradr" name="btc_value" placeholder="<% if (user.btcbalance) { %><%= user.btcbalance %> BTC = <%= (user.btcbalance * btcrate).toFixed(3).toString().replace(/\B(?=(\d{3})+(?!\d))/g,',') %> USD <% } else { %>0.000000000 BTC <% } %>" type="number" step="any" readonly />
                                    </div>
                                    <button class="button is-primary topup" style="margin-top:1vh;">Top-up</button>
                                    <button class="button is-primary withdraw" style="margin-top:1vh;">Withdraw</button>
                                    <button class="button is-primary coinswitch" style="margin-top:1vh;" id="myButton">Deposit with Altcoins</button>
                                    <div class="modal modalTopup">
                                        <div class="modal-background"></div>
                                        <div class="modal-card">
                                            <header class="modal-card-head">
                                                <p class="modal-card-title">Add Bitcoin</p>
                                                <button class="delete deleteTopup is-large" aria-label="close"></button>
                                            </header>
                                            <section class="modal-card-body">
                                                <p class="title is-5 modal-section-title">Instructions</p>
                                                <div style="text-align: left;">
                                                    <p class="subtitle">1. Input value to deposit</p>
                                                    <p class="subtitle">2. Click continue to start transaction</p>
                                                    <p class="subtitle">3. Check your order details</p>
                                                    <p class="subtitle">4. Press button to show deposit form</p>
                                                    <p class="subtitle">5. Check your email and form for confirmation</p>
                                                </div>
                                                <br>
                                                <p class="title is-5 modal-section-title">Input Value</p>
                                                <form action="/dashboard/addresses/btc" method="POST">
                                                    <input type="hidden" name="btcrate" value="<%= btcrate %>" />
                                                    <input type="hidden" name="maxConfirmationsBTC" value="<%= maxConfirmationsBTC %>" />
                                                    <label class="label adrlabel">Value</label>
                                                    <input class="input adradr" name="coinsValue" placeholder="0.000000000 BTC" type="number" step="any" style="width: 60%;" />
                                                    <button class="button is-primary">Continue</button>
                                                </form>
                                            </section>
                                            <footer class="modal-card-foot">
                                                <button class="button is-danger cancelTopup">Cancel</button>
                                            </footer>
                                        </div>
                                    </div>
                                    <div class="modal modalWithdraw">
                                        <div class="modal-background"></div>
                                        <div class="modal-card">
                                            <header class="modal-card-head">
                                                <p class="modal-card-title">Withdraw Bitcoin</p>
                                                <button class="delete deleteWithdraw is-large" aria-label="close"></button>
                                            </header>
                                            <section class="modal-card-body">
                                                <p class="title is-5 modal-section-title">Instructions</p>
                                                <div style="text-align: left;">
                                                    <p class="subtitle">1. Input how much you wish to withdraw</p>
                                                    <p class="subtitle">2. Add a withdrawal address (if you haven't already)</p>
                                                    <p class="subtitle">3. Bear in mind there will be 0.00005 BTC subtracted to cover transaction fee.</p>
                                                    <p class="subtitle">4. Click continue to start the transaction</p>
                                                    <p class="subtitle">5. If you've received a succes message, check your wallet for your funds.</p>
                                                </div>
                                                <br>
                                                <p class="title is-5 modal-section-title">Input Value</p>
                                                <form class="modal-form" action="/dashboard/addresses/withdrawBTC" method="POST">
                                                    <label class="label adrlabel">Value</label>
                                                    <input class="input adradr" name="value" placeholder="0.000000000 BTC" type="number" step="any" style="width: 60%;" required/>
                                                    <% if(user.btcadr) { %>
                                                    <input type="hidden" name="address" value="<%= user.btcadr %>" />
                                                    <% } else { %>
                                                    <input class="input adradr" name="address" placeholder="Bitcoin Address" type="text" required />
                                                    <% } %>
                                                    <button class="button is-primary">Continue</button>
                                                </form>
                                            </section>
                                            <footer class="modal-card-foot">
                                                <button class="button is-danger cancelWithdraw">Cancel</button>
                                                <p class="subtitle">Your withdrawal will also have 0.00005000 (BTC) subtracted to cover the transaction fee.</p>
                                            </footer>
                                        </div>
                                    </div>
                                    <div class="modal modalCoinswitch">
                                        <div class="modal-background"></div>
                                        <div class="modal-card">
                                            <header class="modal-card-head">
                                                <p class="modal-card-title">Deposit Altcoins</p>
                                                <button class="delete deleteCoinswitch is-large" aria-label="close"></button>
                                            </header>
                                            <section class="modal-card-body">
                                                    <div class="steps" id="stepsDemo">
                                                        <div class="step-item is-active is-success">
                                                            <div class="step-marker">1</div>
                                                            <div class="step-details">
                                                            <p class="step-title">Pair</p>
                                                            </div>
                                                        </div>
                                                        <div class="step-item">
                                                            <div class="step-marker">2</div>
                                                            <div class="step-details">
                                                            <p class="step-title">Rate</p>
                                                            </div>
                                                        </div>
                                                        <div class="step-item">
                                                            <div class="step-marker">3</div>
                                                            <div class="step-details">
                                                            <p class="step-title">Deposit</p>
                                                            </div>
                                                        </div>
                                                        <div class="step-item">
                                                            <div class="step-marker">4</div>
                                                            <div class="step-details">
                                                            <p class="step-title">Status</p>
                                                            </div>
                                                        </div>
                                                        <div class="steps-content">
                                                            <div class="step-content has-text-centered is-active">
                                                            <div class="field is-horizontal">
                                                                <div class="field-label is-normal">
                                                                <label class="label">Receive BTC</label>
                                                                </div>
                                                                <div class="field-body">
                                                                <div class="field">
                                                                    <div class="control">
                                                                        <input class="input" name="btc_value" placeholder="Balance: <% if (user.btcbalance) { %><%= user.btcbalance %> BTC<% } else { %>0.000000000 BTC <% } %>" type="number" step="any" readonly data-validate="require" readonly/>
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            <div class="field is-horizontal">
                                                                <div class="field-label is-normal">
                                                                <label class="label">Deposit With</label>
                                                                </div>
                                                                <div class="field-body">
                                                                <div class="field">
                                                                    <div class="control">
                                                                        <select name="counter" class="select" id="counter" style="width: 100%;" data-validate="require">
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            </div>
                                                            <div class="step-content has-text-centered">
                                                            <div class="field is-horizontal">
                                                                <div class="field-label is-normal">
                                                                <label class="label">Deposit Coin:</label>
                                                                </div>
                                                                <div class="field-body">
                                                                <div class="field">
                                                                    <div class="control">
                                                                        <input class="input" name="depositCoin" id="depositCoin" placeholder="Loading..." type="string" step="any" readonly data-validate="require" />
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            <div class="field is-horizontal">
                                                                <div class="field-label is-normal">
                                                                <label class="label">Instant Rate:</label>
                                                                </div>
                                                                <div class="field-body">
                                                                <div class="field">
                                                                    <div class="control">
                                                                        <input class="input" name="rate" id="rate" placeholder="Loading..." type="number" step="any" readonly data-validate="require" />
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            <div class="field is-horizontal">
                                                                <div class="field-label is-normal">
                                                                <label class="label">Max Deposit:</label>
                                                                </div>
                                                                <div class="field-body">
                                                                <div class="field">
                                                                    <div class="control has-icon has-icon-right">
                                                                        <input class="input" name="max" id="max" placeholder="Loading..." type="number" step="any" readonly data-validate="require" />
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            <div class="field is-horizontal">
                                                                <div class="field-label is-normal">
                                                                <label class="label">Min Deposit:</label>
                                                                </div>
                                                                <div class="field-body">
                                                                <div class="field">
                                                                    <div class="control has-icon has-icon-right">
                                                                        <input class="input" name="min" id="min" placeholder="Loading..." type="number" step="any" readonly data-validate="require" />
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            <div class="field is-horizontal">
                                                                <div class="field-label is-normal">
                                                                <label class="label">Miner Fee:</label>
                                                                </div>
                                                                <div class="field-body">
                                                                <div class="field">
                                                                    <div class="control has-icon has-icon-right">
                                                                        <input class="input" name="fee" id="fee" placeholder="Loading..." type="number" step="any" readonly data-validate="require" />
                                                                        <input type="hidden" id="depositCoinAmount" value="1" required />
                                                                        <input type="hidden" id="refundAddress" value="none" required />
                                                                        <input type="hidden" id="currentUser" value="<%= currentUser %>" required />
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            </div>
                                                            <div class="step-content has-text-centered">
                                                            <div class="field is-horizontal">
                                                                <div class="field-label is-normal">
                                                                <label class="label">Deposit to:</label>
                                                                </div>
                                                                <div class="field-body">
                                                                <div class="field">
                                                                    <div class="control">
                                                                        <input class="input" name="depositAddress" id="depositAddress" placeholder="Loading..." type="string" step="any" readonly data-validate="require" />
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            <div class="field is-horizontal">
                                                                <div class="field-label is-normal">
                                                                <label class="label">Minimum Deposit:</label>
                                                                </div>
                                                                <div class="field-body">
                                                                <div class="field">
                                                                    <div class="control">
                                                                        <input class="input" name="expectedAmount" id="expectedAmount" placeholder="Loading..." type="number" step="any" readonly data-validate="require" />
                                                                        <input type="hidden" id="orderIdHidden" required />
                                                                        <input type="hidden" id="end" required />
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            </div>
                                                            <div class="step-content has-text-centered">
                                                                <div class="field is-horizontal">
                                                                    <div class="field-label is-normal">
                                                                    <label class="label">Order ID:</label>
                                                                    </div>
                                                                    <div class="field-body">
                                                                    <div class="field">
                                                                        <div class="control">
                                                                            <input class="input" name="orderId" id="orderId" placeholder="Loading..." type="string" step="any" readonly data-validate="require" />
                                                                        </div>
                                                                    </div>
                                                                    </div>
                                                                </div>
                                                                <div class="field is-horizontal">
                                                                    <div class="field-label is-normal">
                                                                    <label class="label">Status:</label>
                                                                    </div>
                                                                    <div class="field-body">
                                                                    <div class="field">
                                                                        <div class="control">
                                                                            <input class="input" name="status" id="status" placeholder="Loading..." type="string" step="any" readonly data-validate="require" />
                                                                        </div>
                                                                    </div>
                                                                    </div>
                                                                </div>
                                                                <div class="field is-horizontal">
                                                                    <div class="field-label is-normal">
                                                                    <label class="label">Created Date:</label>
                                                                    </div>
                                                                    <div class="field-body">
                                                                    <div class="field">
                                                                        <div class="control">
                                                                            <input class="input" name="createDate" id="createDate" placeholder="Loading..." type="number" step="any" readonly data-validate="require" />
                                                                        </div>
                                                                    </div>
                                                                    </div>
                                                                </div>
                                                                <div class="field is-horizontal">
                                                                    <div class="field-label is-normal">
                                                                    <label class="label">Valid until:</label>
                                                                    </div>
                                                                    <div class="field-body">
                                                                    <div class="field">
                                                                        <div class="control">
                                                                            <input class="input" name="expirationDate" id="expirationDate" placeholder="Loading..." type="number" step="any" readonly data-validate="require" />
                                                                        </div>
                                                                    </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="steps-actions">
                                                            <div class="steps-action">
                                                                <a href="#" data-nav="previous" class="button is-light">Previous</a>
                                                            </div>
                                                            <div class="steps-action">
                                                                <a href="#" data-nav="next" class="button is-light" id="next">Next</a>
                                                            </div>
                                                        </div>
                                            </section>
                                            <footer class="modal-card-foot">
                                                <button class="button is-danger cancelCoinswitch">Cancel</button>
                                            </footer>
                                        </div>
                                        <script>
                                        bulmaSteps.attach();
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <div class="columns">
                    <div class="column frame">
                        <h4 class="new-text">Payments Received</h4>
                        <br>
                        <% if (dealsSold.length == 0) { %>
                            <p>You haven't sold any products yet.</p>
                        <% } else { %>
                            <table class="table is-hoverable is-bordered new-table">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Product</th>
                                        <th>Buyer</th>
                                        <th>Paid On</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% dealsSold.forEach( (deal, index) => { %>
                                        <tr>
                                            <td><%= index + 1 %></td>
                                            <td><a href="/products/<%= deal.product.id %>/view" class="link"><%= deal.product.name %></a></td>
                                            <td><a href="/profile/<%= deal.buyer.id %>" class="link"><%= deal.buyer.name %></a></td>
                                            <td><%= deal.refundableUntil.toUTCString() %></td>
                                            <td><% if (deal.paid == true) { %><p>Paid</p><% } else { %>Payment Pending<% } %></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        <% } %>
                    </div>
                </div>
                <br>
                <div class="columns">
                    <div class="column frame">
                        <h4 class="new-text">Payments Sent</h4>
                        <br>
                        <% if (dealsBought.length == 0) { %>
                            <p>You haven't made any payments yet.</p>
                        <% } else { %>
                            <table class="table is-hoverable is-bordered new-table">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Product</th>
                                        <th>Seller</th>
                                        <th>Paid On</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% dealsBought.forEach( (deal, index) => { %>
                                        <tr>
                                            <td><%= index + 1 %></td>
                                            <td><a href="/products/<%= deal.product.id %>/view" class="link"><%= deal.product.name %></a></td>
                                            <td><a href="/profile/<%= deal.product.author.id %>" class="link"><%= deal.product.author.name%></a></td>
                                            <td><%= deal.createdAt.toUTCString() %></td>
                                            <td><% if (deal.paid == true) { %><p>Paid</p><% } else { %>Payment Pending<% } %></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        <% } %>
                    </div>
                </div>
                <br>
                <div class="columns">
                    <div class="column frame">
                        <h4 class="new-text">Withdraw History</h4>
                        <br>
                        <% if (dealsBought.length == 0) { %>
                            <p>You haven't made any withdrawals yet.</p>
                        <% } else { %>
                            <table class="table is-hoverable is-bordered new-table">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Address</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% user.withdrawal.forEach( (withdrawal, index) => { %>
                                        <tr>
                                            <td><%= index + 1 %></td>
                                            <td><%= withdrawal.sentTo %></td>
                                            <td><%= withdrawal.amount %></td>
                                            <td><%= withdrawal.createdAt.toUTCString() %></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        <% } %>
                    </div>
                </div>
            </div>  
        </div>    
    </div> 
</div>
<script src="../../dist/js/dashboard_addr.js"></script>
<script type="text/javascript" src="/dist/js/client.js"></script>
<% include ../partials/footer %>
